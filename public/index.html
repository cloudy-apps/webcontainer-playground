<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
/>
<link rel="stylesheet" href="/codemirror.css" />
<link rel="stylesheet" href="/xterm.css" />
<script src="/codemirror.js"></script>
<script src="/xterm.js"></script>
<script src="/xterm-addon-fit.js"></script>
<style>
  .CodeMirror {
    height: 100%;
    width: 100%;
  }
</style>

<body class="bg-gray-200">
  <div id="app" class="flex h-screen">
    <div id="editor" class="w-1/2 h-full border-r"></div>
    <div id="terminal" class="w-1/2 h-full pl-2"></div>
  </div>
  <div id="preview" class="flex h-screen">
    <iframe src="" id="wc" class="h-full pt-2"></iframe>
  </div>
</body>

<script type="module">
  import { WebContainer } from "https://unpkg.com/@webcontainer/api@1.1.5/dist/index.js";

  async function getContainer() {
    const webcontainer = await WebContainer.boot();

    webcontainer.on("server-ready", (port, url) => {
      document.getElementById("wc").src = url;
    });

    await webcontainer.mount([]);

    return webcontainer;
  }

  async function getEditor() {
    const codeMirror = CodeMirror(document.getElementById("editor"), {
      lineNumbers: true,
    });

    window.addEventListener("resize", () => codeMirror.refresh());
    setTimeout(() => codeMirror.refresh(), 1);

    return codeMirror;
  }

  async function getTerminal() {
    const term = new Terminal({ convertEol: true });
    term.open(document.getElementById("terminal"));
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    fitAddon.fit();

    return term;
  }

  window.addEventListener("DOMContentLoaded", async () => {
    const editor = await getEditor();
    const terminal = await getTerminal();
    const webcontainer = await getContainer();
    const shell = await webcontainer.spawn("sh");

    const input = new ReadableStream({
      start(controller) {
        terminal.onData((data) => controller.enqueue(data));
      },
    });

    const output = new WritableStream({
      write(data) {
        terminal.write(data);
      },
    });

    shell.output.pipeTo(output);
    input.pipeTo(shell.input);

    window.ui = { terminal, editor, webcontainer };
  });
</script>
