<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
/>
<link rel="stylesheet" href="/codemirror.css" />
<link rel="stylesheet" href="/xterm.css" />
<script src="/codemirror.js"></script>
<script src="/xterm.js"></script>
<script src="/xterm-addon-fit.js"></script>

<body class="bg-gray-200">
  <div id="app" class="h-screen flex flex-col">
    <div class="tabs flex justify-around border-b-2">
      <button class="tab w-1/3 py-2" data-target="editor">Editor</button>
      <button class="tab w-1/3 py-2" data-target="preview">Preview</button>
      <button class="tab w-1/3 py-2" data-target="terminal">Terminal</button>
    </div>
    <div class="tab-content w-full h-full">
      <div class="w-full h-full p-4 flex">
        <div id="files" class="w-1/3 pr-2 border-r-2 border"></div>
        <div id="editor"></div>
      </div>
      <div id="preview" class="w-full h-full p-4 hidden">
        <iframe src="" id="wc" class="h-full pt-2"></iframe>
      </div>
      <div id="terminal" class="w-full h-full p-4 hidden"></div>
    </div>
  </div>
</body>

<script type="module">
  import { WebContainer } from "https://unpkg.com/@webcontainer/api@1.1.5/dist/index.js";

  async function getContainer() {
    const webcontainer = await WebContainer.boot();

    webcontainer.on("server-ready", (port, url) => {
      document.getElementById("wc").src = url;
    });

    await webcontainer.mount([]);

    return webcontainer;
  }

  async function getEditor() {
    const codeMirror = CodeMirror(document.getElementById("editor"), {
      lineNumbers: true,
    });

    window.addEventListener("resize", () => codeMirror.refresh());
    setTimeout(() => codeMirror.refresh(), 1);

    return codeMirror;
  }

  async function getTerminal() {
    const term = new Terminal({ convertEol: true });
    term.open(document.getElementById("terminal"));
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    fitAddon.fit();

    return term;
  }

  function getTabs() {
    const tabs = document.querySelectorAll(".tab");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab-content > div").forEach((t) => {
          t.classList.add("hidden");
        });

        document.getElementById(tab.dataset.target).classList.remove("hidden");
      });
    });

    // Refresh CodeMirror when its tab is clicked
    document
      .querySelector('.tab[data-target="editor"]')
      .addEventListener("click", () => {
        setTimeout(() => {
          codeMirror.refresh();
        }, 1);
      });

    // Refresh Xterm when its tab is clicked
    document
      .querySelector('.tab[data-target="terminal"]')
      .addEventListener("click", () => {
        setTimeout(() => {
          if (term.element) {
            // check if terminal is attached
            term.focus();
          }
        }, 1);
      });
  }

  window.addEventListener("DOMContentLoaded", async () => {
    const currentFile = { path: "index.js" };
    const editor = await getEditor();
    const terminal = await getTerminal();
    const webcontainer = await getContainer();
    const shell = await webcontainer.spawn("sh");

    const input = new ReadableStream({
      start(controller) {
        terminal.onData((data) => {
          console.log(data, String(data));
          controller.enqueue(data);
        });
      },
    });

    const output = new WritableStream({
      write(data) {
        terminal.write(data);
      },
    });

    shell.output.pipeTo(output);
    input.pipeTo(shell.input);
    
    editor.on("change", () =>
      webconainer.fs.writeFile(currentFile.path, editor.getValue())
    );

    window.ui = { terminal, editor, webcontainer };
  });
</script>
